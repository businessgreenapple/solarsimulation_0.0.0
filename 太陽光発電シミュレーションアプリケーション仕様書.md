# 太陽光発電シミュレーションアプリケーション仕様書

## 北海道、東北は今後追加予定

## 概要
本アプリケーションは、太陽光発電システムの導入を検討するユーザーに対して、1時間単位の精密な発電量計算と経済効果シミュレーションを提供するWebアプリケーションです。国立研究開発法人 新エネルギー・産業技術総合開発機構（NEDO）発行の全国日射量データベース「MONSOLA-20」を使用し、高精度な発電量予測を実現しています。


## 技術スタック
- **フロントエンド**: HTML5, CSS3, JavaScript (ES6+)
- **バックエンド**: Python Flask
- **データベース**: JSONファイル（静的データ）
- **グラフ描画**: Chart.js
- **日射量データ**: NEDO MONSOLA-20データベース

## 1. フロントエンド：入力フロー

### ステップ1: 場所の選択

#### 入力項目
- **都道府県**: プルダウン選択（必須）
- **地点**: プルダウン選択（必須）

#### 動的生成ロジック
1. **都道府県リスト**: `nedo_locations_master.json`から動的に読み込み
   - 対象都道府県: 茨城県～鹿児島県（38都道府県）
   - データ構造: `prefectures`配列に都道府県名を格納

2. **地点リスト**: 都道府県選択時に動的に更新
   - データソース: `nedo_locations_master.json`の`locations`オブジェクト
   - 地点名形式: "地点名（地点ID）"（例: "北茨城（40046）"）
   - 地点ID: NEDOデータベースの地点識別子（5桁の数字）

#### 連動関係
- 都道府県選択 → 該当都道府県の地点リストを動的生成
- 地点選択 → 地点IDを抽出してNEDOデータファイルの特定に使用

### ステップ2: 電気契約の選択

#### 入力項目
- **電力会社**: プルダウン選択（必須）
- **契約プラン**: プルダウン選択（必須）
- **使用形態**: プルダウン選択（必須）
- **月別使用量**: 12ヶ月分の数値入力（必須）

#### 動的生成ロジック
1. **電力会社リスト**: 固定配列
   - 対象: 東京電力、中部電力、関西電力、中国電力、四国電力、九州電力

2. **契約プラン**: 電力会社選択時に動的更新
   - データソース: 各電力会社専用のJSONファイル
     - `tepco_plans.json`（東京電力）
     - `chuden_plans.json`（中部電力）
     - `kepco_plans.json`（関西電力）
     - `chugoku_plans.json`（中国電力）
     - `shikoku_plans.json`（四国電力）
     - `kyushu_plans.json`（九州電力）

3. **使用形態**: 固定選択肢
   - 朝型: 朝の時間帯に電力使用量が高いパターン
   - 昼型: 昼の時間帯に電力使用量が高いパターン
   - 夜型: 夜の時間帯に電力使用量が高いパターン

4. **月別使用量**: 12ヶ月分の入力フィールド
   - 入力項目: `usage_jan`～`usage_dec`
   - 単位: kWh
   - バリデーション: 数値のみ、0以上の値

#### 連動関係
- 電力会社選択 → 該当電力会社の契約プランリストを動的生成
- 契約プラン選択 → 料金計算に使用する単価情報を取得
- 使用形態選択 → 24時間の電力使用パターンを決定
- 月別使用量 → 年間消費電力量の算出に使用

### ステップ3: 太陽電池の選択

#### 入力項目
- **モジュール型式**: プルダウン選択（必須）
- **枚数**: プルダウン選択（必須）
- **設置面**: プルダウン選択（必須）
- **傾斜角度**: プルダウン選択（必須）

#### 動的生成ロジック
1. **モジュール型式**: `module_data.json`から動的読み込み
   - データ構造: `modules`配列にモジュール情報を格納
   - 含まれる情報: 型式名、定格出力（W）、効率（%）、寸法、メーカー等

2. **枚数**: 1～30枚の固定配列

3. **設置面**: 固定選択肢
   - 東面: 方位角90度
   - 南東面: 方位角135度
   - 南面: 方位角180度
   - 南西面: 方位角225度
   - 西面: 方位角270度
   - 北面: 方位角0度

4. **傾斜角度**: `roof_angles.json`から動的読み込み
   - データ構造: 角度の配列（0度、10度、20度、30度）

#### 計算ロジック
- **システム容量**: モジュール定格出力（W）× 枚数 ÷ 1000 = 容量（kW）
- **設置面傾斜係数**: 設置面と傾斜角度の組み合わせから`installation_coefficients.json`で取得

### ステップ4: 周辺機器の選択

#### 入力項目
- **パワーコンディショナ**: プルダウン選択（必須）
- **台数**: プルダウン選択（必須）
- **ストリング構成**: 直列枚数・並列数の入力（必須）

#### 動的生成ロジック
1. **パワーコンディショナ**: `inverter_data.json`から動的読み込み
   - データ構造: `inverters`配列にインバータ情報を格納
   - 含まれる情報: 型式名、定格出力（kW）、効率（%）、電圧範囲等

2. **台数**: 1～5台の固定配列

3. **ストリング構成**: 動的入力フィールド
   - 直列枚数: 数値入力
   - 並列数: 数値入力
   - バリデーション: 直列枚数 × 並列数 = ステップ3で選択したモジュール総枚数

#### 動的追加ロジック
- 台数が2台以上の場合、2台目以降のストリング構成入力欄を動的に追加
- 各台のストリング構成は独立して入力可能
- 合計モジュール枚数がステップ3の選択枚数と一致することを検証

### ステップ5: 蓄電池の選択

#### 入力項目
- **蓄電池型式**: プルダウン選択（任意）

#### 動的生成ロジック
1. **蓄電池型式**: `battery_data.json`から動的読み込み
   - データ構造: `batteries`配列に蓄電池情報を格納
   - 含まれる情報: 型式名、容量（kWh）、実効容量（kWh）、定格出力（kW）、充放電効率（%）等

2. **選択肢**: "なし" + 蓄電池型式リスト

## 2. バックエンド：計算ロジック

### 2.1. 年間発電量の計算

#### 計算フロー
1. **地点データの取得**
   - 地点名から地点IDを抽出（例: "北茨城（40046）" → "40046"）
   - NEDOデータファイルの特定: `static/nedo/nedo_solar_data/hm{地点ID}year.json`

2. **システム仕様の取得**
   - モジュール容量: 定格出力（W）× 枚数 ÷ 1000
   - インバータ効率: 選択したインバータの効率（%）
   - 設置面傾斜係数: 設置面と傾斜角度の組み合わせから`installation_coefficients.json`で取得
   - システム効率係数: 0.95（固定値）

3. **1時間単位の発電量計算（8760時間）**
   ```python
   for month in range(12):
       for day in range(days_in_month[month]):
           if day_count >= 365:
               break
           
           daily_row = nedo_data['daily_data'][day_count]
           
           for hour in range(24):
               # その時間の日射量を取得（0.01MJ/m²単位）
               hourly_radiation = float(daily_row[4 + hour])
               
               # 欠損値チェック（8888は欠損値）
               if hourly_radiation != 8888:
                   # 月別温度損失係数を取得
                   temperature_coefficient = get_temperature_coefficient(month + 1)
                   
                   # 1時間あたりの発電量計算
                   # 計算式: システム容量(kW) × 1時間あたりの日射量(kWh/m²) × 損失係数(K)
                   # 0.01MJ/m²をkWh/m²に変換: 0.01 / 3.6
                   hourly_generation = (module_capacity * 
                                      hourly_radiation * 0.01 / 3.6 * 
                                      inverter_efficiency * 
                                      temperature_coefficient * 
                                      system_efficiency * 
                                      installation_coefficient)
   ```

4. **月別・年間集計**
   - 月別発電量: 各月の1時間発電量を合計
   - 年間発電量: 12ヶ月分の合計

#### 考慮される損失係数
- **月別温度損失係数**: 
  - 12月、1月、2月: 0.98（温度損失2%）
  - 3月、4月、5月、6月: 0.93（温度損失7%）
  - 7月、8月: 0.88（温度損失12%）
  - 9月、10月、11月: 0.93（温度損失7%）
- **システム効率係数**: 0.95（配線・回路ロス等5%）
- **インバータ効率**: 選択したインバータの効率（%）
- **設置面傾斜係数**: 設置面と傾斜角度の組み合わせから`installation_coefficients.json`で取得
  - 南面: 0度(1.0)～30度(1.06)
  - 南東面: 0度(0.99)～30度(1.035)
  - 東面: 0度(0.98)～30度(0.92)
  - 南西面: 0度(0.99)～30度(1.03)
  - 西面: 0度(0.97)～30度(0.91)
- **推定発電電力**: 最大でもシステム容量の70～80%

### 2.2. 年間自家消費量の計算

#### 計算フロー
1. **年間消費電力の算出**
   - 月別使用量から年間使用量を算出
   - 使用形態パターンを適用して24時間の使用比率を決定

2. **1時間単位の自家消費量計算**
   ```python
   for hour in range(8760):  # 8760時間
       # その時間の消費電力
       consumption = annual_usage * hourly_ratio[hour % 24]
       
       # その時間の発電電力
       generation = hourly_generation_array[hour]
       
       # 自家消費量（発電量と消費量の小さい方）
       self_consumption = min(generation, consumption)
       
       # 売電量（発電量が消費量を上回る分）
       sell_electricity = max(0, generation - consumption)
   ```

3. **年間集計**
   - 年間自家消費量: 8760時間分の自家消費量を合計
   - 年間売電量: 8760時間分の売電量を合計

### 2.3. 経済効果の計算

#### 計算フロー
1. **買電単価の取得**
   - 選択した契約プランから料金情報を取得
   - デフォルト値: 30.0円/kWh

2. **売電単価の設定（FIT制度対応）**
   - 1年目～4年目: 24.0円/kWh（FIT制度適用期間）
   - 5年目～10年目: 8.3円/kWh（FIT制度終了後）

3. **10年間の経済効果計算**
   ```python
   for year in range(1, 11):
       # その年の売電単価
       sell_price = sell_prices[year]
       
       # 売電収入
       sell_revenue = annual_sell_electricity * sell_price
       
       # 自家消費による節約額
       self_consumption_savings = annual_self_consumption * buy_price
       
       # 合計経済効果
       total_effect = sell_revenue + self_consumption_savings
   ```

4. **蓄電池ありの場合の追加計算**
   - 充放電パターンの計算
   - 蓄電池ありの自家消費量・売電量の再計算
   - 蓄電池なしとの比較データ生成

## 3. フロントエンド：結果表示

### ステップ6: シミュレーション結果

#### 表示項目

##### 入力内容の確認
- 場所情報（都道府県、地点）
- 電気契約情報（電力会社、契約プラン、使用形態、月別使用量）
- 太陽電池情報（モジュール型式、枚数、設置面、傾斜角度）
- 周辺機器情報（パワーコンディショナ、台数、ストリング構成）
- 蓄電池情報（型式、容量）

##### 年間発電量の内訳
- **推定年間発電量**: 年間総発電量（kWh）
- **月別発電量**: 12ヶ月分の月別発電量（kWh）
- **時間別平均発電量**: 24時間の平均発電量（kWh）
- **月別発電量グラフ**: Chart.jsによる可視化

##### 自家消費・売電の内訳
- **年間自家消費量**: 自家消費による節約量（kWh）
- **年間売電量**: 売電による収入量（kWh）
- **1日の電力の流れグラフ**: 発電量、消費量、売電量の24時間パターン

##### 経済効果
- **年間売電収入**: 売電による年間収入（円）
- **年間節約額**: 自家消費による年間節約額（円）
- **年間合計経済効果**: 売電収入 + 節約額（円）
- **買電単価**: 契約プランから算出（円/kWh）
- **売電単価**: FIT制度に基づく単価（円/kWh）

##### 10年間の経済効果詳細
- **年次別詳細テーブル**: 年次、売電単価、売電額、自家消費量、自家消費額、合計経済効果、累計経済効果
- **10年間総経済効果**: 10年間の合計金額
- **FIT制度情報**: 適用期間（4年間）、適用単価（24円/kWh）、終了後単価（8.3円/kWh）

##### 蓄電池関連（選択時のみ表示）
- **蓄電池の充放電パターングラフ**: 24時間の充放電パターン
- **蓄電池ありなしの比較グラフ**: 自家消費量・売電量の比較
- **蓄電池詳細情報**: 容量、実効容量、定格出力、充放電効率
- **年間充電量・放電量**: 蓄電池の年間運用実績

##### 環境効果
- **CO2削減効果**: 0.3925kg-CO2/kWhで算出
- **石油削減量**: 0.222L/kWhで算出
- **スギの木のCO2吸収量**: 1本あたり14kgとして換算

##### 注意事項
- 発電量の保証に関する注意
- 遠隔出力制御による抑制分の非考慮
- NEDOデータベースの使用について
- 太陽電池容量の算出根拠
- 損失係数の考慮事項
- 環境効果の算出根拠
- 計算過程の端数処理について

#### グラフ表示
- **月別発電量グラフ**: 12ヶ月の月別発電量
- **1日の電力の流れグラフ**: 24時間の発電・消費・売電パターン
- **蓄電池充放電パターングラフ**: 24時間の充放電パターン（蓄電池選択時）
- **蓄電池比較グラフ**: 蓄電池ありなしの自家消費・売電比較（蓄電池選択時）

#### 操作性
- **入力内容の折りたたみ表示**: 表示/非表示の切り替え
- **戻るボタン**: 前のステップに戻る
- **最初からやり直すボタン**: ステップ1から再開始
- **レスポンシブデザイン**: モバイル・タブレット対応

## データファイル構成

### マスターデータ
- `nedo_locations_master.json`: 都道府県・地点マスター
- `module_data.json`: 太陽電池モジュールデータ
- `inverter_data.json`: パワーコンディショナデータ
- `battery_data.json`: 蓄電池データ
- `usage_patterns.json`: 電気使用形態パターン
- `roof_angles.json`: 屋根傾斜角度データ
- `installation_coefficients.json`: 設置係数データ

### 電力会社データ
- `tepco_plans.json`: 東京電力プランデータ
- `chuden_plans.json`: 中部電力プランデータ
- `kepco_plans.json`: 関西電力プランデータ
- `chugoku_plans.json`: 中国電力プランデータ
- `shikoku_plans.json`: 四国電力プランデータ
- `kyushu_plans.json`: 九州電力プランデータ

### 料金関連データ
- `tepco_fuel_adjustment.json`: 東京電力燃料調整費
- `chuden_fuel_adjustment.json`: 中部電力燃料調整費
- `kepco_fuel_adjustment.json`: 関西電力燃料調整費
- `chugoku_fuel_adjustment.json`: 中国電力燃料調整費
- `shikoku_fuel_adjustment.json`: 四国電力燃料調整費
- `kyushu_fuel_adjustment.json`: 九州電力燃料調整費
- `renewable_energy_surcharge.json`: 再生可能エネルギー発電促進賦課金

### NEDOデータ
- `static/nedo/nedo_solar_data/`: NEDO日射量データファイル群
- ファイル形式: `hm{地点ID}year.json`
- データ内容: 8760時間分の日射量データ

## 計算精度と制約事項

### 計算精度
- **時間単位**: 1時間単位の精密計算
- **年間**: 8760時間分の積算
- **月別**: 各月の日数に応じた正確な集計
- **端数処理**: 表示時は四捨五入、計算時は小数点以下保持

### 制約事項
- **NEDOデータ**: 地点IDに対応するデータファイルが必要
- **モジュールデータ**: 選択した型式のデータがマスターに存在する必要
- **インバータデータ**: 選択した型式のデータがマスターに存在する必要
- **蓄電池データ**: 選択した型式のデータがマスターに存在する必要
- **電力会社データ**: 選択した電力会社・プランのデータが存在する必要

### エラーハンドリング
- データファイルの読み込みエラー
- 地点IDの抽出エラー
- 計算過程での数値エラー
- フォームデータの不整合エラー
- バリデーションエラー

## 更新・保守

### データ更新
- **NEDOデータ**: 年次更新
- **電力料金**: 月次更新（燃料調整費）
- **設備データ**: 新製品発売時
- **FIT制度**: 制度変更時

### 機能拡張
- 新電力会社の追加
- 新設備の追加
- 計算ロジックの改善
- UI/UXの改善

---

**作成日**: 2025年1月
**バージョン**: 2.0
**作成者**: システム開発チーム
